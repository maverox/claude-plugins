---
name: github-review-publisher
description: |
  Create and format GitHub PR review comments with line-level precision. Generates structured, severity-categorized comments and publishes them as pending reviews for manual approval. Auto-activates for: "create review comments", "publish review", "post review to GitHub", "create pending review".
allowed-tools: Bash, Read, Write
version: 1.0.0
---

# GitHub Review Publisher Skill

## Overview

This skill creates professional, well-formatted GitHub PR review comments from identified code issues. It generates line-level comments with proper severity indicators, code examples, and suggested fixes, then publishes them as a **pending GitHub review** for manual approval before posting.

This is a **generic skill** that works with any repository and any code review workflow.

## When to Use This Skill

This skill **auto-activates** when users request:
- "Create review comments for PR #238"
- "Publish review to GitHub"
- "Post review comments"
- "Create pending review"
- "Generate GitHub review"

The skill can also be invoked as the final step in `/pr-review` workflow to publish review findings.

## Input Context

The skill expects review data from upstream skills:

1. **From code-quality-review**:
   ```yaml
   issues:
     - severity: CRITICAL
       category: Security
       file: src/api/handler.ts
       line_number: 45
       line_reference: "NEW_FILE"
       commit_sha: "abc123..."
       code_at_line: "eval(userInput)"
       issue: "Potential code injection vulnerability"
       current_code: "eval(userInput)"
       suggested_fix: "JSON.parse(userInput)"
       impact: "Remote code execution risk"
   ```

2. **Direct input** (for standalone use):
   ```
   User: "Create review for these issues: [issue list]"
   ```

## Process

### Step 1: Collect Review Data

Gather all issues from upstream skills:

**Combine and Deduplicate**:
- Merge issues from all sources
- Remove duplicates (same file + line)
- Sort by severity (Critical -> Warning -> Suggestion)

---

### Step 2: Format Review Comments

Transform each issue into a GitHub-compatible review comment:

#### **Enhanced Comment Structure**

```markdown
## {severity_emoji} {SEVERITY}: {category}

**Issue**: {one-line-summary}

### Current Implementation
```{language}
{current_code}
```
{status_emoji} {impact_summary}

### Suggested Fix
```{language}
{suggested_fix}
```
{success_emoji} {benefit_summary}

### Why This Matters
{detailed_explanation}

### Impact Assessment
- **Severity**: {severity} ({priority})
- **Failure Mode**: {what_breaks_if_not_fixed}
- **Effort to Fix**: {Low|Medium|High}

---
*Auto-generated by code-quality-review | Line {line_number} | Commit {short_sha}*
```

#### **Severity-Based Styling**

| Severity | Header Format | Status | Emoji |
|----------|---------------|--------|-------|
| Critical | `## CRITICAL: {category}` | Blocks merge | |
| Warning | `## WARNING: {category}` | Should fix | |
| Suggestion | `## SUGGESTION: {category}` | Nice to have | |

#### **Code Block Enhancement Rules**

1. **Always specify language** for syntax highlighting (typescript, python, rust, go, etc.)
2. **Add inline annotations** in code blocks using comments
3. **Use consistent formatting** for current vs. suggested code

Example with annotations:
```typescript
// AVOID: This pattern is vulnerable to injection
const result = eval(userInput);

// PREFER: Safe JSON parsing
const result = JSON.parse(userInput);
```

#### **Impact Assessment Templates**

**For Critical Issues**:
```markdown
### Impact Assessment
- **Severity**: Critical (P0 - Blocks Merge)
- **Failure Mode**: {specific_runtime_or_security_failure}
- **Effort to Fix**: {Low|Medium|High}
- **Testing Required**: {unit_tests|integration_tests|manual_testing}
```

**For Warnings**:
```markdown
### Impact Assessment
- **Severity**: Warning (P1 - Should Fix)
- **Code Quality Impact**: {maintainability|performance|security}
- **Effort to Fix**: {Low|Medium|High}
```

**For Suggestions**:
```markdown
### Impact Assessment
- **Severity**: Suggestion (P2 - Nice to Have)
- **Benefit**: {improvement_description}
- **Effort to Fix**: {Low|Medium|High}
```

---

### Step 2.5: Validate Line Numbers Against PR Diff

**Purpose**: Ensure all line numbers exist in the NEW file before calling GitHub API to prevent "422 Line could not be resolved" errors.

#### **Process**:

#### A. Normalize Input (Backward Compatibility)

Handle both old and new issue formats:

```bash
normalize_issue() {
  local issue="$1"

  # Backward compatibility: 'line' -> 'line_number'
  if grep -q "^  line:" <<< "$issue" && ! grep -q "^  line_number:" <<< "$issue"; then
    echo "Warning: Old format detected (using 'line' instead of 'line_number'), normalizing..."
    issue=$(echo "$issue" | sed 's/^  line:/  line_number:/')
  fi

  # Default line_reference to NEW_FILE if missing
  if ! grep -q "^  line_reference:" <<< "$issue"; then
    echo "Warning: Missing 'line_reference', assuming NEW_FILE"
    issue+=$'\n  line_reference: "NEW_FILE"'
  fi

  echo "$issue"
}
```

#### B. Fetch PR Diff and Extract Valid Ranges

```bash
# 1. Fetch PR diff
gh pr diff {pr-number} --repo {owner}/{repo} > /tmp/pr_diff.txt

# 2. Parse valid line ranges per file
declare -A FILE_RANGES

while IFS= read -r line; do
  # Detect file path
  if [[ "$line" =~ ^\+\+\+\ b/(.+)$ ]]; then
    current_file="${BASH_REMATCH[1]}"
    FILE_RANGES["$current_file"]=""
  fi

  # Parse hunk header: @@ -old +new @@
  if [[ "$line" =~ ^@@\ -[0-9]+,[0-9]+\ \+([0-9]+),([0-9]+) ]]; then
    new_start="${BASH_REMATCH[1]}"
    new_count="${BASH_REMATCH[2]}"
    new_end=$((new_start + new_count - 1))

    # Append range
    if [[ -z "${FILE_RANGES[$current_file]}" ]]; then
      FILE_RANGES["$current_file"]="$new_start-$new_end"
    else
      FILE_RANGES["$current_file"]="${FILE_RANGES[$current_file]},$new_start-$new_end"
    fi
  fi
done < /tmp/pr_diff.txt
```

#### C. Validate Each Issue

```bash
# Validate line number is in valid ranges
is_line_valid() {
  local file="$1"
  local line_num="$2"
  local ranges="${FILE_RANGES[$file]}"

  # File not in PR
  if [[ -z "$ranges" ]]; then
    echo "FILE_NOT_IN_PR"
    return 1
  fi

  # Check each range
  IFS=',' read -ra RANGE_ARRAY <<< "$ranges"
  for range in "${RANGE_ARRAY[@]}"; do
    IFS='-' read -r start end <<< "$range"
    if (( line_num >= start && line_num <= end )); then
      echo "VALID"
      return 0
    fi
  done

  echo "LINE_NOT_IN_RANGE:$ranges"
  return 1
}

# Classify issues
VALID_ISSUES=()
SKIPPED_ISSUES=()

for issue in "${ALL_ISSUES[@]}"; do
  file=$(echo "$issue" | grep "file:" | cut -d: -f2- | xargs)
  line_num=$(echo "$issue" | grep "line_number:" | cut -d: -f2 | xargs)

  result=$(is_line_valid "$file" "$line_num")

  if [[ "$result" == "VALID" ]]; then
    VALID_ISSUES+=("$issue")
  else
    SKIPPED_ISSUES+=("$file:$line_num:$result")
  fi
done
```

**Reference**: See `references/line-validation.md` for complete validation algorithm and edge cases.

#### D. Proceed with Valid Issues Only

- Use `VALID_ISSUES` array for Step 3 (create review)
- Save `SKIPPED_ISSUES` for reporting in Step 4

**Benefit**: Eliminates "422 Line could not be resolved" errors entirely.

---

### Step 3: Create Pending Review via gh CLI

**CRITICAL**: GitHub API has deprecated the `position` parameter. Use `line` and `side` instead.

#### **Get HEAD Commit SHA**

```bash
COMMIT_SHA=$(gh pr view {pr-number} --repo {owner}/{repo} --json headRefOid -q '.headRefOid')
```

#### **Map File Lines to Diff Lines**

**Important**: The `line` parameter expects the **actual line number in the new file**, NOT a diff position.

**Parameters**:
- `line`: The line number in the new version of the file (RIGHT side)
- `side`: Always use `"RIGHT"` for new file content
- `path`: Relative path to the file from repository root

**Example**: If you want to comment on line 22 of `src/api/handler.ts`:
```json
{
  "path": "src/api/handler.ts",
  "line": 22,
  "side": "RIGHT",
  "body": "Comment text here"
}
```

#### **Create Pending Review with Inline Comments**

**CRITICAL CONSTRAINTS**:
1. Can only have ONE pending review per user per PR
2. Must use GitHub API `/pulls/{pr}/reviews` endpoint
3. Use `line` parameter (not deprecated `position`)
4. Do NOT include `event` parameter (creates PENDING state)
5. Leave `body` empty for inline-only reviews (no general comment)

**Working Method: GitHub API with Form Fields**

```bash
# Get commit SHA
COMMIT_SHA=$(gh pr view {pr-number} --repo {owner}/{repo} --json headRefOid -q '.headRefOid')

# Create pending review with multiple inline comments
gh api repos/{owner}/{repo}/pulls/{pr-number}/reviews \
  -X POST \
  -F commit_id="$COMMIT_SHA" \
  -F body="" \
  -F 'comments[][path]=src/api/handler.ts' \
  -F 'comments[][line]=22' \
  -F 'comments[][side]=RIGHT' \
  -F 'comments[][body]=**Warning** - Issue description here' \
  -F 'comments[][path]=src/utils/crypto.ts' \
  -F 'comments[][line]=45' \
  -F 'comments[][side]=RIGHT' \
  -F 'comments[][body]=**Suggestion** - Another comment'
```

**Key Parameters**:
- `commit_id`: HEAD commit SHA from PR
- `body`: Empty string for inline-only (or brief summary)
- `comments[]`: Array of comment objects
  - `path`: Relative file path from repo root
  - `line`: Actual line number in NEW file
  - `side`: Always `"RIGHT"` for new content
  - `body`: Formatted comment text (markdown supported)

**IMPORTANT NOTES**:
- Start with fewer comments and add more if successful
- Validate ALL line numbers exist in the new file
- If you get 422 "Line could not be resolved", a line number is invalid
- Only ONE pending review allowed - delete existing before creating new
- Comments are NOT posted publicly until manually submitted in GitHub UI

#### **Troubleshooting 422 "Line could not be resolved"**

This error occurs when:
1. Line number doesn't exist in the NEW file version
2. File path is incorrect
3. Using `position` instead of `line`

**Solution**:
- Verify line numbers exist in the PR's changed files
- Use `gh pr diff {pr-number}` to see actual line numbers
- Ensure file paths match exactly (relative from repo root)

---

### Step 4: Generate Review Summary

Create a comprehensive summary for display in chat:

#### **Summary Structure**

```markdown
# PR Review Complete: PR #{number}

## PR Information
- **Repository**: {owner}/{repo}
- **Title**: {pr_title}
- **Author**: @{author}
- **Files Changed**: {file_count}

## Review Statistics
- **Total Pending Comments**: {total_comments}
  - Critical: {critical_count}
  - Warning: {warning_count}
  - Suggestions: {suggestion_count}

## Summary
{overall_assessment}

## Line-Level Comments Created (Pending Approval)

All comments below have been created as PENDING and are attached to specific lines

### {file_path_1}

**Line {line}** - {severity} - {category}
> {issue_description}
> ```{language}
> {suggested_fix}
> ```

[... all comments grouped by file ...]

---

**{total_comments} Pending Review Comments Created**

**Next Steps:**
1. Go to GitHub PR: {pr_url}/files
2. You will see pending comments on specific lines
3. Manually review and approve/edit/delete each comment
4. Submit your review when ready

**Comments are NOT posted publicly yet** - they're pending your manual approval in GitHub UI.
```

#### **Skipped Comments Report** (if any)

If any comments were skipped during validation, include this section:

```markdown
---

**{skipped_count} Comment(s) Skipped Due to Invalid Line Numbers**

**Skipped Comments**:

1. **File**: `{file_path}`
   **Line**: {line_number}
   **Reason**: {skip_reason}
   **Valid Lines in PR**: {valid_ranges}
   **Issue**: {issue_description}
   **Action**: Verify line number in GitHub UI or re-run upstream skill

**Note**: These comments were not included in the pending review to avoid API errors.

**How to Fix**:
- View file at HEAD commit: https://github.com/{owner}/{repo}/blob/{commit_sha}/{file_path}
- Verify the correct line number for each issue
- Add comments manually in GitHub UI if needed
```

---

## Output

The skill produces:

### 1. GitHub Pending Review

**Created via gh CLI**:
- Review ID (for later reference)
- Pending status (not posted)
- Line-level comments attached

**User can**:
- View in GitHub UI
- Edit each comment
- Delete unwanted comments
- Add more comments
- Submit review when ready

---

### 2. Chat Summary

**Displayed to user**:
- Complete review statistics
- All comments listed (for reference)
- Next steps instructions
- GitHub PR URL

---

### 3. Review Metadata (Optional)

**Saved to file** (for tracking):
```yaml
review_metadata:
  pr_number: 238
  repository: owner/repo
  review_id: 123456789
  status: PENDING
  created_at: 2025-01-08T16:30:00Z
  comments_count: 12
  severity_breakdown:
    critical: 2
    warnings: 5
    suggestions: 5
```

---

## Integration with Other Skills

### Upstream Skills (Providers)

**1. pr-analysis**
- Provides PR metadata (number, title, author)
- Supplies file paths for comments
- Provides commit SHA (CRITICAL)

**2. code-quality-review**
- Provides code quality issues
- Categorized by severity
- With line numbers and suggestions

---

### Standalone Usage

Can be used independently for:
- Publishing review from custom issue list
- Creating follow-up reviews
- Adding comments to existing reviews
- Re-reviewing after fixes

---

## Reference Files

### 1. `references/comment-formatting.md`
Comment structure guidelines:
- Markdown formatting best practices
- Severity indicator usage
- Code block formatting
- Suggested fix templates

### 2. `references/gh-api-patterns.md`
GitHub API usage patterns:
- Creating pending reviews
- Line-level comment syntax
- Multi-line comment ranges
- Error handling
- Review status management

### 3. `references/line-validation.md`
Line number validation algorithm:
- Extracting valid line ranges from diff
- Validating issues before API calls
- Handling edge cases

---

## Error Handling

### Commit SHA Not Found
```
Error: Could not get HEAD commit SHA for PR #{pr-number}

Solution: Verify PR exists and is accessible
```

### Comment Skipped: Line Not in PR Diff
```
Warning: Comment skipped - Line {line_number} not in valid ranges for {file_path}

Cause: Line number doesn't exist in the NEW file version or is outside changed hunks

Solutions:
1. View file at HEAD commit in GitHub to verify line number
2. Check if file was renamed (update file path in issue)
3. Ensure upstream skill extracted line number from NEW file, not diff output
4. Run validation manually: gh pr diff {pr} | grep "@@ " to see valid ranges
```

### Comment Skipped: File Not in PR
```
Warning: Comment skipped - File {file_path} not modified in this PR

Cause: File path doesn't appear in PR diff

Solutions:
1. Verify file path is correct (relative from repo root)
2. Check if file was renamed (use new path)
3. Ensure file is actually part of the PR changes
```

### Authentication Failed
```
Error: gh CLI not authenticated

Solution: Run 'gh auth login' to authenticate with GitHub
```

### 422 Unprocessable Entity (Should No Longer Occur)
```
Error: {"message":"Unprocessable Entity","errors":["Line could not be resolved"]}

Cause: This error should be prevented by Step 2.5 (validation)

If this error still occurs:
1. Check validation logic is running correctly
2. Verify FILE_RANGES parsing is working
3. Review validation logs for skipped issues
```

---

## Examples

### Example 1: Successful Review Creation

**Input**: Issues from code-quality-review

**Process**:
1. Collect 8 issues (1 critical, 3 warnings, 4 suggestions)
2. Format each as GitHub comment
3. Validate line numbers against PR diff
4. Get commit SHA
5. Create pending review with all valid comments
6. Display summary

**Output**:
```
Review Created Successfully!

**8 pending comments** created for PR #42

**Severity Breakdown**:
- Critical: 1
- Warning: 3
- Suggestions: 4

**Files with Comments**:
1. src/api/handler.ts (3 comments)
2. src/utils/crypto.ts (2 comments)
3. tests/handler.test.ts (3 comments)

**Next Steps**:
Go to https://github.com/owner/repo/pull/42/files

You will see your pending review comments. Review, edit, or delete them, then submit when ready.

Comments are PENDING - not posted publicly yet!
```

---

### Example 2: Review with Skipped Comments

**Input**: Issues with some invalid line numbers

**Process**:
1. Validate 10 issues against PR diff
2. 8 valid, 2 invalid (line doesn't exist)
3. Create review with 8 valid comments
4. Report 2 skipped comments

**Output**:
```
Review Created with Warnings

**Comments Created**: 8/10
**Skipped**: 2 comments (invalid line numbers)

**Skipped Comments**:
1. src/api/handler.ts:999 - Line doesn't exist in file
2. src/missing.ts:50 - File not in PR

**Action Required**: Manually verify line numbers and add comments in GitHub UI

**Next Steps**: Review the 8 pending comments in GitHub
```

---

## Advanced Features

### Multi-File Review Organization

Comments are grouped by file in the summary for easy navigation:

```markdown
### src/api/handler.ts

**Line 25** - Critical - Security
> Potential SQL injection vulnerability

**Line 45** - Warning - Error Handling
> Empty catch block swallows errors

**Line 120** - Suggestion - Documentation
> Add JSDoc comment for this function

---

### src/utils/crypto.ts

**Line 67** - Warning - Security
> Weak encryption algorithm detected

...
```

---

### Review Statistics

**Auto-calculated**:
- Total comments
- Severity breakdown
- Files affected
- Average issues per file

---

### Recommendation Engine

Based on severity distribution, provide recommendation:

```markdown
## Recommendation

**Overall Assessment**: REQUEST CHANGES

**Critical issues detected** (1). This should be fixed before merging:
1. SQL injection vulnerability (handler.ts:25)

After fixing critical issues, re-run review to verify.
```

**Recommendation Logic**:
- Critical issues (>=1) -> BLOCK MERGE / REQUEST CHANGES
- Warnings only (>=3) -> REQUEST CHANGES
- Warnings only (<3) -> APPROVE WITH COMMENTS
- Suggestions only -> APPROVE

---

## Performance Considerations

- **Batch Comments**: Create single review with all comments (not individual comments)
- **Deduplication**: Remove duplicate issues before creating comments
- **Line Validation**: Pre-validate line numbers to avoid API errors
- **Retry Logic**: Retry on transient failures (rate limiting, network issues)

---

## Version History

- **1.0.0** (2025-01-08): Initial skill for software-engineering-suite
  - Pending review creation
  - Line-level comment formatting
  - Severity-based categorization
  - Multi-file organization
  - Review statistics
  - Recommendation engine
  - Line number validation
